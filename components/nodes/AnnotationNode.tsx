import React, { memo, useState } from "react";
import { NodeProps, useReactFlow } from "reactflow";
import { NodeData } from "../../types";
import JumpTargetBadge from "./JumpTargetBadge";

const AnnotationNode = ({ id, data }: NodeProps<NodeData>) => {
  const { setNodes } = useReactFlow();
  const [editingField, setEditingField] = useState<"label" | "content" | null>(
    null
  );

  // Only store asset IDs in node data
  const handleChange = (field: string, value: string) => {
    setNodes((nds) =>
      nds.map((node) => {
        if (node.id === id) {
          // If updating assets, ensure only IDs are stored
          if (field === 'assets') {
            return {
              ...node,
              data: { ...node.data, assets: value }
            };
          }
          return {
            ...node,
            data: { ...node.data, [field]: value }
          };
        }
        return node;
      })
    );
  };

  const arrowDirection = data.arrowDirection || "top-left";
  const color = data.color || "#71717a";

  const getArrowStyle = () => {
    switch (arrowDirection) {
      case 'top-right':
        return { 
            top: -50, 
            right: -50, 
            transform: 'scaleY(-1)' 
        };
      case 'bottom-left':
        return { 
            bottom: -50, 
            left: -50, 
            transform: 'scaleX(-1)' 
        };
      case 'bottom-right':
        return { 
            bottom: -50, 
            right: -50, 
            transform: 'none' 
        };
      case 'top-left':
      default:
        return { 
            top: -50, 
            left: -50, 
            transform: 'rotate(180deg)' 
        };
    }
  };  const arrowStyle = getArrowStyle();

  return (
    <div
      className="relative flex flex-col max-w-[250px] select-none group"
      style={{ color: color }}
    >
      <JumpTargetBadge nodeId={id} />
      <div className="flex items-center gap-2 mb-1">
        {editingField === "label" ? (
          <input
            className="nodrag bg-transparent border-none outline-none font-bold text-base w-full"
            style={{ color: "inherit" }}
            value={data.label}
            onChange={(e) => handleChange("label", e.target.value)}
            autoFocus
            onBlur={() => setEditingField(null)}
            onKeyDown={(e) => {
              if (e.key === "Enter") setEditingField(null);
            }}
          />
        ) : (
          <div
            className="font-bold text-base cursor-text"
            style={{ color: "inherit" }}
            onDoubleClick={() => setEditingField("label")}
          >
            {data.label}
          </div>
        )}
      </div>

      {editingField === "content" ? (
        <textarea
          className="nodrag bg-transparent border-none outline-none text-sm leading-snug w-full resize-none h-20"
          style={{ color: "inherit", opacity: 0.8 }}
          value={data.content}
          onChange={(e) => handleChange("content", e.target.value)}
          autoFocus
          onBlur={() => setEditingField(null)}
          
        />
      ) : (
        <div
          className="text-sm leading-snug cursor-text min-h-[1.5rem]"
          style={{ color: "inherit", opacity: 0.8 }}
          onDoubleClick={() => setEditingField("content")}
        >
          {data.content || "Double click to edit..."}
        </div>
      )}

      {/* Arrow */}
      <div
        className="absolute opacity-80 pointer-events-none transition-all duration-300 flex items-center justify-center"
        style={{ ...arrowStyle, color: "inherit", width: 40, height: 40 }}
      >
        <svg
          version="1.1"
          xmlns="http://www.w3.org/2000/svg"
          width="100%"
          height="100%"
          viewBox="0 0 512 512"
        >
                    <path
            d="M0 0 C17.38264645 16.11704515 27.81235219 38.7918454 28.91015625 62.3671875 C29.59618625 87.29294423 22.20170155 112.13576589 5.25390625 130.8125 C-12.64397589 149.63196172 -36.13873934 159.93669602 -62.1015625 160.80859375 C-64.92084755 160.86079846 -67.73885816 160.87586864 -70.55859375 160.875 C-71.29898895 160.8760675 -72.03938416 160.87713501 -72.80221558 160.87823486 C-118.26056733 160.78427357 -157.42171765 140.06950714 -189.6015625 109.10888672 C-191.56493919 107.25440592 -193.57597875 105.45961564 -195.58984375 103.66015625 C-196.99735434 102.35813223 -198.40362485 101.05476626 -199.80859375 99.75 C-200.49042725 99.15670898 -201.17226074 98.56341797 -201.87475586 97.95214844 C-203.73891543 96.17889376 -205.14876847 94.70372772 -206.37109375 92.4375 C-206.44409188 89.14506963 -205.57164014 86.47807105 -204.37109375 83.4375 C-203.73300781 81.81134766 -203.73300781 81.81134766 -203.08203125 80.15234375 C-202.64117187 79.23582031 -202.2003125 78.31929688 -201.74609375 77.375 C-201.07707031 75.96541016 -201.07707031 75.96541016 -200.39453125 74.52734375 C-200.05679688 73.83769531 -199.7190625 73.14804688 -199.37109375 72.4375 C-196.05639138 75.02458477 -193.14413756 77.59636253 -190.43359375 80.8125 C-181.43820654 91.3237396 -171.36913584 101.05300363 -160.37109375 109.4375 C-159.83613281 109.85950684 -159.30117187 110.28151367 -158.75 110.71630859 C-139.31228832 126.03838234 -116.84687509 136.35296653 -92.37109375 140.4375 C-90.87642578 140.71013672 -90.87642578 140.71013672 -89.3515625 140.98828125 C-63.92049476 144.4820397 -37.28286443 141.12900487 -16.37109375 125.4375 C-1.77476677 113.14014874 7.00233999 95.24775527 9.62890625 76.4375 C11.44796453 55.09484532 6.12745329 36.88943274 -7.12109375 20.0625 C-24.10095053 0.81178092 -51.25429724 -9.33604968 -76.37109375 -11.5625 C-111.42394883 -13.3515478 -145.74375823 -5.04909482 -173.37109375 17.4375 C-173.96212891 17.90800781 -174.55316406 18.37851563 -175.16210938 18.86328125 C-183.26769117 25.35117038 -190.09563305 32.11776043 -196.37109375 40.4375 C-197.42296875 41.69820312 -197.42296875 41.69820312 -198.49609375 42.984375 C-211.00140218 58.43736328 -219.25467754 77.34694057 -224.37109375 96.4375 C-224.70343018 97.65276367 -224.70343018 97.65276367 -225.04248047 98.89257812 C-230.5965939 120.12163392 -230.81075032 145.14914704 -225.37109375 166.4375 C-225.16709961 167.23655762 -224.96310547 168.03561523 -224.75292969 168.85888672 C-221.67740709 180.51856447 -217.65595119 191.60284505 -212.37109375 202.4375 C-212.06445801 203.06994629 -211.75782227 203.70239258 -211.44189453 204.35400391 C-203.89304887 219.70606276 -193.76968244 232.75413679 -182.37109375 245.4375 C-181.76910156 246.11296875 -181.16710937 246.7884375 -180.546875 247.484375 C-150.48387032 279.28906509 -105.9813061 294.21932893 -63.93359375 300.6875 C-62.9605127 300.83872314 -61.98743164 300.98994629 -60.98486328 301.14575195 C-57.45357503 301.64678636 -53.9165794 302.05424146 -50.37109375 302.4375 C-49.22551498 302.56930161 -49.22551498 302.56930161 -48.05679321 302.70376587 C-24.42943255 305.31529642 -0.6003055 304.70407567 23.13195801 304.63311768 C27.75652384 304.62218703 32.38106064 304.62265239 37.00563717 304.62325573 C41.4673191 304.62298467 45.92898185 304.61751756 50.39065742 304.61025429 C52.51777566 304.6070763 54.64489605 304.60510225 56.77201653 304.60436058 C59.71906179 304.60220115 62.66601215 304.59347248 65.61303711 304.58276367 C66.92417229 304.58344345 66.92417229 304.58344345 68.26179504 304.58413696 C71.63157783 304.56616179 74.40992558 304.51049356 77.62890625 303.4375 C79.14389857 295.42333351 77.6931629 289.35650154 75.4453125 281.59765625 C75.11095688 280.39435165 74.77660126 279.19104706 74.43211365 277.95127869 C73.54757524 274.77752565 72.64952828 271.60804035 71.74414062 268.44018555 C70.46666581 263.95604583 69.21647589 259.46419016 67.96141052 254.97373962 C67.29273569 252.58748294 66.61956606 250.20248045 65.94154358 247.81886292 C65.63800461 246.74692184 65.33446564 245.67498077 65.02172852 244.57055664 C64.61749413 243.1523336 64.61749413 243.1523336 64.20509338 241.70545959 C63.62890625 239.4375 63.62890625 239.4375 63.62890625 237.4375 C67.08209686 238.69881578 69.84726387 240.13518664 72.78125 242.34375 C73.55025635 242.91746338 74.3192627 243.49117676 75.11157227 244.08227539 C75.92166748 244.69449951 76.7317627 245.30672363 77.56640625 245.9375 C79.28195647 247.21824613 80.99810598 248.49818989 82.71484375 249.77734375 C83.55499023 250.40495605 84.39513672 251.03256836 85.26074219 251.67919922 C88.37655025 253.9926064 91.52596436 256.25520896 94.69140625 258.5 C99.93709495 262.22738185 105.16366135 265.98011819 110.37890625 269.75 C111.13405518 270.29575684 111.8892041 270.84151367 112.66723633 271.40380859 C115.76547513 273.64341233 118.86319271 275.88373648 121.9609375 278.12402344 C130.0507406 283.97383484 138.14303476 289.81929791 146.27539062 295.60986328 C149.66923933 298.02911373 153.05109061 300.46423685 156.42578125 302.91015625 C157.24691406 303.50505859 158.06804687 304.09996094 158.9140625 304.71289062 C160.53217917 305.88608932 162.14939702 307.06052889 163.765625 308.23632812 C164.49910156 308.76806641 165.23257812 309.29980469 165.98828125 309.84765625 C166.64280273 310.32340088 167.29732422 310.79914551 167.97167969 311.28930664 C169.63469709 312.49946946 169.63469709 312.49946946 171.62890625 313.4375 C170.30798916 316.49516342 169.09686206 318.12770511 166.34765625 319.99609375 C165.68008301 320.45749756 165.01250977 320.91890137 164.32470703 321.39428711 C163.23778564 322.12723999 163.23778564 322.12723999 162.12890625 322.875 C160.57344809 323.94679909 159.01878563 325.01975371 157.46484375 326.09375 C156.66272461 326.64546875 155.86060547 327.1971875 155.03417969 327.765625 C151.2307577 330.40933529 147.49567791 333.14510983 143.75390625 335.875 C136.83517687 340.90113858 129.81377391 345.75649975 122.73925781 350.56005859 C116.50039297 354.80918305 110.36903162 359.19229076 104.26220703 363.62841797 C91.20173792 373.1152266 77.95388232 382.32701838 64.62890625 391.4375 C63.41391513 387.92950403 63.8586164 385.75044035 64.90820312 382.22924805 C65.21181763 381.19104416 65.51543213 380.15284027 65.82824707 379.08317566 C66.33285461 377.40811699 66.33285461 377.40811699 66.84765625 375.69921875 C67.53923884 373.32882748 68.23063941 370.95838311 68.921875 368.58789062 C70.02368283 364.85387716 71.13001685 361.12926896 72.24072266 357.38989258 C73.30901972 353.78802163 74.36030998 350.18150321 75.41015625 346.57421875 C75.91476379 344.90826912 75.91476379 344.90826912 76.42956543 343.20866394 C78.75939819 335.35064896 78.75939819 335.35064896 77.62890625 327.4375 C75.85346567 325.46165661 74.40435208 324.55177709 71.75913048 324.16195202 C69.33987374 324.04063287 66.93769182 324.02410537 64.51538086 324.03686523 C63.59256317 324.02988617 62.66974548 324.0229071 61.71896362 324.01571655 C58.65630033 323.99567342 55.59397328 323.99623953 52.53125 323.99609375 C50.38203539 323.98430701 48.23282892 323.97093964 46.08363342 323.95606995 C40.40089568 323.919797 34.71822971 323.89968208 29.03540039 323.88452148 C18.95058741 323.8568413 8.86588742 323.81175142 -1.21875 323.74609375 C-2.83539677 323.73566481 -2.83539677 323.73566481 -4.48470306 323.72502518 C-20.52400048 323.6085315 -36.41119516 323.15477637 -52.37109375 321.4375 C-53.10292877 321.36216034 -53.83476379 321.28682068 -54.58877563 321.209198 C-58.57298027 320.79119583 -62.53419456 320.27907298 -66.49609375 319.6875 C-67.64239258 319.51831055 -68.78869141 319.34912109 -69.96972656 319.17480469 C-124.91614966 310.66453338 -177.89313892 286.27605631 -211.67626953 240.67578125 C-234.68376392 209.03736734 -247.85815729 173.29072187 -247.74609375 134 C-247.74488525 133.211698 -247.74367676 132.423396 -247.74243164 131.61120605 C-247.62587391 103.46820024 -241.08708616 77.13187331 -227.37109375 52.4375 C-226.56091797 50.91382813 -226.56091797 50.91382813 -225.734375 49.359375 C-205.51289423 12.73548247 -171.55796197 -13.25802355 -131.66796875 -24.97265625 C-86.37562742 -37.74741919 -36.53202966 -30.76381445 0 0 Z "
            fill="currentColor"
            transform="translate(323.37109375,103.5625)"
          />
          <path
            d="M0 0 C4.5573677 1.42946103 6.94833197 6.02791296 9.07055664 10.05615234 C9.59641357 11.25449707 10.12227051 12.4528418 10.6640625 13.6875 C10.9572084 14.34631165 11.25035431 15.00512329 11.55238342 15.68389893 C12.17791967 17.09086362 12.79946633 18.49960792 13.41729736 19.90997314 C15.05653133 23.64592833 16.73234208 27.36541955 18.40625 31.0859375 C18.73999634 31.8290921 19.07374268 32.5722467 19.41760254 33.33792114 C27.68861235 51.69831604 37.21094787 69.32020156 47.31640625 86.7265625 C47.78884766 87.54334473 48.26128906 88.36012695 48.74804688 89.20166016 C53.34973119 97.14598426 57.98952909 104.98565787 63.234375 112.52734375 C64.31640625 114.7265625 64.31640625 114.7265625 64.234375 116.59765625 C62.89065231 119.71394929 61.21133876 122.59011342 59.44140625 125.4765625 C59.08949219 126.07855469 58.73757812 126.68054687 58.375 127.30078125 C57.32421875 129.0234375 57.32421875 129.0234375 55.31640625 131.7265625 C54.32640625 131.7265625 53.33640625 131.7265625 52.31640625 131.7265625 C51.08056641 130.33154297 51.08056641 130.33154297 49.85546875 128.34375 C49.39100342 127.60068604 48.92653809 126.85762207 48.44799805 126.09204102 C47.95082275 125.27018311 47.45364746 124.4483252 46.94140625 123.6015625 C46.41393799 122.74554443 45.88646973 121.88952637 45.34301758 121.00756836 C43.65455672 118.25488663 41.98440332 115.49168355 40.31640625 112.7265625 C39.79191895 111.86595215 39.26743164 111.0053418 38.72705078 110.11865234 C25.97226943 89.16351485 14.52373313 67.53632726 3.81640625 45.4765625 C3.48901459 44.80321869 3.16162292 44.12987488 2.8243103 43.43612671 C-0.76649763 36.03254517 -4.25379232 28.58360832 -7.609375 21.0703125 C-7.90859863 20.41198425 -8.20782227 19.75365601 -8.51611328 19.07537842 C-10.790676 13.91360141 -11.70237476 10.28354985 -10.68359375 4.7265625 C-8.15234653 0.21433919 -4.76475541 0.21544981 0 0 Z "
            fill="currentColor"
            transform="translate(27.68359375,16.2734375)"
          />
          <path
            d="M0 0 C4.5573677 1.42946103 6.94833197 6.02791296 9.07055664 10.05615234 C9.59641357 11.25449707 10.12227051 12.4528418 10.6640625 13.6875 C10.9572084 14.34631165 11.25035431 15.00512329 11.55238342 15.68389893 C12.17791967 17.09086362 12.79946633 18.49960792 13.41729736 19.90997314 C15.05653133 23.64592833 16.73234208 27.36541955 18.40625 31.0859375 C18.73999634 31.8290921 19.07374268 32.5722467 19.41760254 33.33792114 C27.68861235 51.69831604 37.21094787 69.32020156 47.31640625 86.7265625 C47.78884766 87.54334473 48.26128906 88.36012695 48.74804688 89.20166016 C53.34973119 97.14598426 57.98952909 104.98565787 63.234375 112.52734375 C64.31640625 114.7265625 64.31640625 114.7265625 64.234375 116.59765625 C62.89065231 119.71394929 61.21133876 122.59011342 59.44140625 125.4765625 C59.08949219 126.07855469 58.73757812 126.68054688 58.375 127.30078125 C57.32421875 129.0234375 57.32421875 129.0234375 55.31640625 131.7265625 C54.32640625 131.7265625 53.33640625 131.7265625 52.31640625 131.7265625 C51.08056641 130.33154297 51.08056641 130.33154297 49.85546875 128.34375 C49.39100342 127.60068604 48.92653809 126.85762207 48.44799805 126.09204102 C47.95082275 125.27018311 47.45364746 124.4483252 46.94140625 123.6015625 C46.41393799 122.74554443 45.88646973 121.88952637 45.34301758 121.00756836 C43.65455672 118.25488663 41.98440332 115.49168355 40.31640625 112.7265625 C39.79191895 111.86595215 39.26743164 111.0053418 38.72705078 110.11865234 C25.97226943 89.16351485 14.52373313 67.53632726 3.81640625 45.4765625 C3.48901459 44.80321869 3.16162292 44.12987488 2.8243103 43.43612671 C-0.76649763 36.03254517 -4.25379232 28.58360832 -7.609375 21.0703125 C-7.90859863 20.41198425 -8.20782227 19.75365601 -8.51611328 19.07537842 C-10.790676 13.91360141 -11.70237476 10.28354985 -10.68359375 4.7265625 C-8.15234653 0.21433919 -4.76475541 0.21544981 0 0 Z "
            fill="currentColor"
            transform="translate(27.68359375,16.2734375)"
          />
        </svg>
      </div>
    </div>
  );
};

export default memo(AnnotationNode);
